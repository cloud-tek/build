name: ci

env:
  NETCORE_VERSION: 8.0.100
  ACTIONS_ALLOW_UNSECURE_COMMANDS: true
  DOTNET_ROLL_FORWARD: Minor

on:
  pull_request:
    types:
    - closed
    branches:
    - main
    paths: &paths
    - ".github/workflows/**"
    - "build/**"
    - "src/**"
    - "tests/**"
    - "GitVersion.yml"
  push:
    branches:
    - main
    - feature/*
    - hotfix/*
    - bug/*
    - release/*
    paths: *paths
  workflow_dispatch:
    inputs: {}

jobs:
  # pre-merge:
  #   if: (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v2
  #     with:
  #       fetch-depth: "0"
  #   - id: auto-release
  #     uses: cloud-tek/actions/auto-tag@0.12
  #     with:
  #       branch: main

  build:
    if: (github.event_name == 'pull_request' && github.event.pull_request.merged == false) || (github.event_name == 'push')
    uses: ./.github/workflows/dotnet.yml
    name: build
    permissions:
      checks: write
    with:
      Directory: ${{ github.workspace }}
      NetCoreVersion: 8.0.100
      Compile:      true
      UnitTests:    true
      Pack:         true
      Push:         true
      NuGetApiUrl:  'https://api.nuget.org/v3/index.json'
    secrets:
      NuGetApiKey:  '${{ secrets.NUGET_API_KEY }}'
